<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard J&T - Pacotes Retidos (V8 - Vencendo Amanh√£)</title>
    
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary: #d9534f;
            --secondary: #0056b3;
            --warning: #fd7e14;
            --success: #28a745;
            --purple: #6f42c1;
            --info: #17a2b8;
            --dark: #343a40;
            --teal: #009688;
            --delivered: #218838;
            --ativo: #e83e8c;
            --bg: #f4f6f9;
            --text: #333;
        }

        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; }
        body { background: var(--bg); color: var(--text); padding-bottom: 50px; }

        header {
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: white; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        header h1 { font-size: 22px; display: flex; align-items: center; gap: 10px; }
        header p { font-size: 13px; opacity: 0.9; margin-top: 5px; }

        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }

        .card-upload {
            background: white; padding: 20px; border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px;
            display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px; align-items: flex-end;
            border-top: 4px solid var(--secondary);
        }
        .input-group label { display: block; font-weight: 700; margin-bottom: 8px; color: #555; font-size: 11px; text-transform: uppercase; }
        .input-group input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px; }
        
        .btn-main { background: var(--secondary); color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold; transition: 0.2s; white-space: nowrap; height: 37px;}
        .btn-main:hover { background: #004494; }

        #msgErro {
            background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;
            padding: 15px; border-radius: 6px; margin-bottom: 20px; display: none;
        }

        /* KPIs */
        .kpi-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 10px; margin-bottom: 20px; }
        .kpi-card { background: white; padding: 15px; border-radius: 6px; border-left: 5px solid #ccc; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .kpi-card h3 { font-size: 10px; text-transform: uppercase; color: #777; margin-bottom: 5px; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .kpi-card .value { font-size: 22px; font-weight: 800; color: #333; }
        
        .border-purple { border-left-color: var(--purple); }
        .border-ativo { border-left-color: var(--ativo); }
        .border-green { border-left-color: var(--success); }
        .border-red { border-left-color: var(--primary); }
        .border-warning { border-left-color: var(--warning); }
        .border-info { border-left-color: var(--info); }
        .border-dark { border-left-color: var(--dark); }
        .border-del { border-left-color: var(--delivered); }

        /* FILTROS */
        .filters-bar { background: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; gap: 15px; flex-wrap: wrap; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .filter-item { display: flex; flex-direction: column; gap: 5px; margin-right: 15px; }
        .filter-item label { font-size: 11px; font-weight: bold; color: #777; }
        .filter-item input, .filter-item select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; min-width: 150px; }
        
        .days-input-group { display: flex; gap: 5px; }
        .days-input-group select { width: 60px; min-width: 0; }
        .days-input-group input { width: 80px; }

        .checkbox-group { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .checkbox-item { display: flex; align-items: center; gap: 5px; font-size: 12px; background: #f1f3f5; padding: 5px 10px; border-radius: 15px; cursor: pointer; }
        .checkbox-item input { width: auto; margin: 0; cursor: pointer; }

        .main-grid { display: grid; grid-template-columns: 320px 1fr; gap: 20px; align-items: start; }
        @media (max-width: 900px) { .main-grid { grid-template-columns: 1fr; } }

        .ranking-card { background: white; border-radius: 8px; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom:20px; height: auto; }
        .ranking-header { font-weight: bold; color: #333; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; font-size: 16px; }
        .rank-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; font-size: 13px; }
        .rank-name { font-weight: 600; color: #555; width: 50%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .rank-bar-container { flex: 1; background: #f1f1f1; height: 8px; border-radius: 4px; margin: 0 10px; overflow: hidden; }
        .rank-bar { height: 100%; border-radius: 3px; }
        .rank-count { font-weight: bold; color: #333; width: 30px; text-align: right; }
        .bar-blue { background: var(--secondary); }
        .bar-red { background: var(--primary); }

        .table-container { background: white; border-radius: 8px; overflow-x: auto; box-shadow: 0 2px 5px rgba(0,0,0,0.05); padding: 15px; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; min-width: 1000px; }
        th { background: #f1f3f5; padding: 12px; text-align: left; color: #495057; font-weight: 700; cursor: pointer; border-bottom: 2px solid #dee2e6; }
        th:hover { background: #e2e6ea; }
        td { padding: 10px 12px; border-bottom: 1px solid #eee; vertical-align: middle; }
        tr:hover { background-color: #f8f9fa; }

        .badge { padding: 5px 8px; border-radius: 4px; font-weight: bold; font-size: 10px; color: white; display: inline-block; text-transform: uppercase; }
        .status-apto { background-color: var(--success); }
        .status-verify { background-color: var(--warning); } 
        .status-wait { background-color: var(--primary); }
        .status-ausencia-proc { background-color: var(--info); }
        .status-driver { background-color: var(--dark); }
        .status-delivered { background-color: var(--delivered); }
        .status-fazer-ativo { background-color: var(--ativo); }
        .status-descarte { background-color: #000; color: #fff; }
        .status-impressa { background-color: var(--purple); color: #fff; } 
        
        .info-pill { background: #e9ecef; color: #495057; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; white-space: nowrap; border: 1px solid #ced4da; }

        .btn-action { background: #17a2b8; color: white; border: none; padding: 6px 15px; border-radius: 4px; cursor: pointer; font-size: 12px; margin-left: 5px; }
        .btn-excel { background: #218838; }

        #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--secondary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="loadingOverlay" class="hidden">
        <div class="spinner"></div>
        <h3>Analisando Dados...</h3>
        <p style="color:#666; font-size:12px;">Calculando hor√°rios exatos e previs√£o de vencimento</p>
    </div>

    <header>
        <div class="container" style="padding: 0;">
            <h1><i class="fa-solid fa-boxes-packing"></i> Dashboard J&T - Retidos (V8)</h1>
            <p>Contagem de 8 dias na hora exata e identifica√ß√£o autom√°tica de pacotes vencendo nas pr√≥ximas 24h.</p>
        </div>
    </header>

    <div class="container">
        
        <div class="card-upload">
            <div class="input-group">
                <label>1. Mestre Retidos</label>
                <input type="file" id="fileRetidos" accept=".csv, .xlsx, .xls">
            </div>
            <div class="input-group">
                <label>2. Gest√£o de Base</label>
                <input type="file" id="fileBase" accept=".csv, .xlsx, .xls">
            </div>
            <div class="input-group">
                <label>3. Problem√°ticos</label>
                <input type="file" id="fileProb" accept=".csv, .xlsx, .xls">
            </div>
            <div class="input-group">
                <label>4. Etiqueta Impressa (Opcional - Col. A)</label>
                <input type="file" id="fileEtiqueta" accept=".csv, .xlsx, .xls">
            </div>
            <button class="btn-main" onclick="tratarClickCarregar()">
                <i class="fa-solid fa-play"></i> Processar
            </button>
        </div>

        <div id="msgErro"></div>

        <div id="tabOps">
            <div class="filters-bar" style="flex-direction:column; align-items:flex-start;">
                <div style="display:flex; width:100%; gap:15px; margin-bottom:15px; flex-wrap:wrap;">
                    <div class="filter-item" style="flex: 1;"><label>Busca R√°pida</label><input type="text" id="buscaGeral" placeholder="Pedido ou Motorista..." onkeyup="aplicarFiltros()"></div>
                    <div class="filter-item"><label>Dias Retidos (Mestre)</label>
                        <div class="days-input-group">
                            <select id="operadorDias" onchange="aplicarFiltros()"><option value="maior">></option><option value="menor"><</option><option value="igual">=</option></select>
                            <input type="number" id="valorDias" placeholder="Ex: 8" onkeyup="aplicarFiltros()">
                        </div>
                    </div>
                    <div class="filter-item" style="flex: 1;"><label>Cidade Destino</label><select id="filtroCidade" onchange="aplicarFiltros()"><option value="">Todas</option></select></div>
                    <div class="filter-item" style="flex: 1.5;"><label>Status / Regra</label><select id="filtroStatus" onchange="aplicarFiltros()"><option value="">Todos</option></select></div>
                </div>
                <div class="filter-item" style="width:100%;">
                    <label style="margin-bottom:8px; display:block;">Filtrar Grupos R√°pidos:</label>
                    <div class="checkbox-group">
                        <label class="checkbox-item"><input type="checkbox" checked onchange="aplicarFiltros()" value="DELIVERED"> üü¢ Entregues</label>
                        <label class="checkbox-item"><input type="checkbox" checked onchange="aplicarFiltros()" value="IMPRESSA"> üñ®Ô∏è Etiq. Impressas</label>
                        <label class="checkbox-item"><input type="checkbox" checked onchange="aplicarFiltros()" value="APTO"> üü¢ Aptos Devolu√ß√£o</label>
                        <label class="checkbox-item" style="background:#fff3cd; color:#856404; border:1px solid #ffeeba;"><input type="checkbox" checked onchange="aplicarFiltros()" value="PROXIMO"> ‚è≥ Vencendo Amanh√£</label>
                        <label class="checkbox-item"><input type="checkbox" checked onchange="aplicarFiltros()" value="WAIT"> üî¥ Aguardando</label>
                        <label class="checkbox-item"><input type="checkbox" checked onchange="aplicarFiltros()" value="AUSENCIA"> üîµ Proc. Aus√™ncia</label>
                        <label class="checkbox-item"><input type="checkbox" checked onchange="aplicarFiltros()" value="FAZER_ATIVO"> ü©∑ Fazer Ativo</label>
                        <label class="checkbox-item"><input type="checkbox" checked onchange="aplicarFiltros()" value="VERIFY_DRIVER"> ‚ö´ Verif. Motorista</label>
                        <label class="checkbox-item"><input type="checkbox" checked onchange="aplicarFiltros()" value="INVALID"> üü† Inv√°lida</label>
                        <label class="checkbox-item"><input type="checkbox" checked onchange="aplicarFiltros()" value="FINALIZADO"> ‚¨õ Descarte</label>
                    </div>
                </div>
            </div>

            <div class="kpi-row">
                <div class="kpi-card border-gray"><h3>Total</h3><div class="value" id="kpiTotal">0</div></div>
                <div class="kpi-card border-purple"><h3>Etiq. Impressas</h3><div class="value" id="kpiImpressa">0</div></div>
                <div class="kpi-card border-green"><h3>Aptos (Liberados)</h3><div class="value" id="kpiApto">0</div></div>
                <div class="kpi-card border-warning"><h3>Vencendo (D-1)</h3><div class="value" id="kpiProximo">0</div></div>
                <div class="kpi-card border-ativo"><h3>Fazer Ativo</h3><div class="value" id="kpiAtivo">0</div></div>
                <div class="kpi-card border-red"><h3>Aguardando (8D)</h3><div class="value" id="kpiWait">0</div></div>
                <div class="kpi-card border-info"><h3>Aus√™ncias Pend.</h3><div class="value" id="kpiAusencia">0</div></div>
                <div class="kpi-card border-dark"><h3>Verif. Motorista</h3><div class="value" id="kpiDriver">0</div></div>
            </div>

            <div class="main-grid">
                <div class="sidebar">
                    <div class="ranking-card"><div class="ranking-header">Top Cidades Problem√°ticas</div><div id="listaTopCidades"></div></div>
                    <div class="ranking-card"><div class="ranking-header">Top Motoristas (Pendentes)</div><div id="listaTopMotoristas"></div></div>
                </div>
                
                <div class="table-container">
                    <div style="display: flex; justify-content: space-between; align-items:center; margin-bottom: 15px;">
                        <h3>Listagem de Pacotes</h3>
                        <div>
                            <button class="btn-action" onclick="copiarCodigos()"><i class="fa-regular fa-copy"></i> Copiar C√≥digos</button>
                            <button class="btn-action btn-excel" onclick="exportarExcel()"><i class="fa-solid fa-file-excel"></i> Exportar Dados</button>
                        </div>
                    </div>
                    <table id="tabelaDados">
                        <thead>
                            <tr>
                                <th onclick="ordenar('codigo')">Pedido / Remessa</th>
                                <th onclick="ordenar('diasRetidos')" title="Dias retidos desde a previs√£o">Dias</th>
                                <th onclick="ordenar('statusTxt')">Status & Regra</th>
                                <th onclick="ordenar('infoDevolucao')">Info / Libera√ß√£o</th>
                                <th onclick="ordenar('problema')">Motivo Problem√°tico</th>
                                <th onclick="ordenar('motorista')">Motorista</th>
                                <th onclick="ordenar('cidade')">Cidade</th>
                            </tr>
                        </thead>
                        <tbody id="tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <script>
        let dadosRaw = [];
        let dadosFiltrados = [];
        let sortCol = '';
        let sortDir = 'asc';

        function lerArquivo(arquivo) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const wb = XLSX.read(e.target.result, { type: 'array' });
                        const sheet = wb.Sheets[wb.SheetNames[0]];
                        resolve(XLSX.utils.sheet_to_json(sheet, { header: 1 }));
                    } catch (err) { reject(err); }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(arquivo);
            });
        }

        function detectarColunas(matriz, dicionario) {
            let headers = matriz[0] || [];
            let map = {};
            for (let chave in dicionario) {
                map[chave] = -1; 
                let sinominos = dicionario[chave];
                for (let s of sinominos) {
                    for (let i = 0; i < headers.length; i++) {
                        let cabecalho = String(headers[i]).toLowerCase().trim();
                        if (cabecalho.includes(s)) {
                            map[chave] = i;
                            break;
                        }
                    }
                    if (map[chave] !== -1) break;
                }
            }
            return map;
        }

        function limparCodigo(c) { return String(c || "").trim().toUpperCase(); }

        function tratarDataRobustamente(val) {
            if (!val) return null;
            if (val instanceof Date) return isNaN(val) ? null : val;
            if (typeof val === 'number') {
                const d = new Date(Math.round((val - 25569) * 86400 * 1000));
                return isNaN(d) ? null : d;
            }
            let s = String(val).trim();
            let parts = s.split(/[\sT]+/);
            let datePart = parts[0];
            let timePart = parts[1] || "00:00:00"; 
            
            let dParts = datePart.split(/[\/\-]/);
            let tParts = timePart.split(':');
            
            if(dParts.length === 3) {
                let ano, mes, dia;
                if(dParts[0].length === 4) { 
                    ano = parseInt(dParts[0]); mes = parseInt(dParts[1], 10); dia = parseInt(dParts[2], 10);
                } else { 
                    dia = parseInt(dParts[0], 10); mes = parseInt(dParts[1], 10); ano = parseInt(dParts[2]);
                }
                
                let h = parseInt(tParts[0] || 0, 10);
                let m = parseInt(tParts[1] || 0, 10);
                let sec = parseInt(tParts[2] || 0, 10);

                let d = new Date(ano, mes-1, dia, h, m, sec);
                return isNaN(d) ? null : d;
            }
            return null;
        }

        function getDataString(d) {
            if (!d || isNaN(d.getTime())) return null;
            return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        }

        function formatarDataBR(data) {
            if(!data) return "";
            const dd = String(data.getDate()).padStart(2, '0');
            const mm = String(data.getMonth() + 1).padStart(2, '0');
            const hh = String(data.getHours()).padStart(2, '0');
            const min = String(data.getMinutes()).padStart(2, '0');
            return `${dd}/${mm} √†s ${hh}:${min}`;
        }

        function tratarClickCarregar() {
            const fRetidos = document.getElementById('fileRetidos').files[0];
            const fBase = document.getElementById('fileBase').files[0];
            const fProb = document.getElementById('fileProb').files[0];
            const fEtiqueta = document.getElementById('fileEtiqueta').files[0];

            const divErro = document.getElementById('msgErro');
            divErro.style.display = 'none'; divErro.innerHTML = '';

            if(!fRetidos) {
                divErro.style.display = 'block'; divErro.innerHTML = "O Input 1 (Mestre Retidos) √© obrigat√≥rio.";
                return;
            }

            document.getElementById('loadingOverlay').classList.remove('hidden');

            setTimeout(async () => {
                try {
                    const retidos = await lerArquivo(fRetidos);
                    const base = fBase ? await lerArquivo(fBase) : null;
                    const prob = fProb ? await lerArquivo(fProb) : null;
                    const etiqueta = fEtiqueta ? await lerArquivo(fEtiqueta) : null;
                    
                    processarLogica(retidos, base, prob, etiqueta);
                } catch (error) {
                    divErro.style.display = 'block'; divErro.innerHTML = "Erro: " + error.message;
                } finally {
                    document.getElementById('loadingOverlay').classList.add('hidden');
                }
            }, 300);
        }

        function processarLogica(retidos, base, prob, etiqueta) {
            dadosRaw = [];
            
            let colRet = detectarColunas(retidos, {
                pedido: ["remessa", "pedido", "n√∫mero de pedido"],
                previsao: ["prevista", "data prevista"],
                motorista: ["digitalizador de sa√≠da", "digitalizador", "motorista"],
                problema: ["tipo problem√°tico", "problema"]
            });
            if(colRet.pedido===-1) colRet.pedido=0; if(colRet.previsao===-1) colRet.previsao=10;
            if(colRet.motorista===-1) colRet.motorista=13; if(colRet.problema===-1) colRet.problema=17;

            let colBase = base ? detectarColunas(base, {
                remessa: ["n√∫mero de pedido", "pedido", "remessa"],
                motorista: ["respons√°vel", "motorista", "entregador"],
                assinatura: ["marca de assinatura", "assinatura"],
                cidade: ["cidade destino", "munic√≠pio de destino", "cidade"]
            }) : null;
            if(colBase && colBase.remessa===-1) colBase.remessa=0;
            if(colBase && colBase.motorista===-1) colBase.motorista=4;
            if(colBase && colBase.assinatura===-1) colBase.assinatura=10; 
            if(colBase && colBase.cidade===-1) colBase.cidade=19;

            let colProb = prob ? detectarColunas(prob, {
                codigo: ["n√∫mero de pedido", "pedido", "remessa"],
                dataBipe: ["data de registro", "tempo de digitaliza√ß√£o", "tempo"],
                motivo: ["n√≠vel ii", "n√≠vel 2", "tipo problem√°tico", "motivo", "descri√ß√£o"]
            }) : null;
            if(colProb && colProb.codigo===-1) colProb.codigo=0;
            if(colProb && colProb.dataBipe===-1) colProb.dataBipe=11; 
            if(colProb && colProb.motivo===-1) colProb.motivo=4; 

            const mapBase = new Map();
            if(base) {
                for(let i = 1; i < base.length; i++) {
                    if(!base[i] || !base[i][colBase.remessa]) continue;
                    mapBase.set(limparCodigo(base[i][colBase.remessa]), {
                        motorista: base[i][colBase.motorista],
                        assinatura: base[i][colBase.assinatura],
                        cidade: base[i][colBase.cidade]
                    });
                }
            }

            const mapProb = new Map();
            if(prob) {
                for(let i = 1; i < prob.length; i++) {
                    if(!prob[i] || !prob[i][colProb.codigo]) continue;
                    const cod = limparCodigo(prob[i][colProb.codigo]);
                    
                    const dataObj = tratarDataRobustamente(prob[i][colProb.dataBipe]);
                    const dataStr = getDataString(dataObj); 
                    const motivo = String(prob[i][colProb.motivo] || "").trim();

                    if(!mapProb.has(cod)) {
                        mapProb.set(cod, { motivos: [], ausencias: new Set() });
                    }
                    const pData = mapProb.get(cod);
                    
                    if(motivo && dataObj) {
                        pData.motivos.push({ data: dataObj, dataStr: dataStr, motivo: motivo });
                    }

                    const motLow = motivo.toLowerCase();
                    if(motLow.includes("aus√™ncia") || motLow.includes("ausencia") || motLow.includes("ÂÆ¢Êà∑‰∏çÂú®")) {
                        if(dataStr) {
                            pData.ausencias.add(dataStr);
                        } else {
                            pData.ausencias.add("desconhecido-" + i);
                        }
                    }
                }

                mapProb.forEach(v => {
                    v.motivos.sort((a,b) => b.data - a.data); 
                    v.ultimoMotivo = v.motivos.length > 0 ? v.motivos[0].motivo : "";
                });
            }

            const setEtiquetas = new Set();
            if(etiqueta) {
                let colEtiq = detectarColunas(etiqueta, { codigo: ["n√∫mero", "pedido", "remessa", "pacote", "c√≥digo"] });
                let idxCodEtiq = colEtiq.codigo !== -1 ? colEtiq.codigo : 0; 
                
                for(let i = 1; i < etiqueta.length; i++) {
                    if(!etiqueta[i] || !etiqueta[i][idxCodEtiq]) continue;
                    setEtiquetas.add(limparCodigo(etiqueta[i][idxCodEtiq]));
                }
            }

            const agora = new Date(); 
            const amanha = new Date(agora.getTime() + 24 * 60 * 60 * 1000); // 24 horas para frente
            const hojeZered = new Date(); hojeZered.setHours(0,0,0,0);

            for(let i = 1; i < retidos.length; i++) {
                const linha = retidos[i];
                if (!linha || !linha[colRet.pedido]) continue;

                const codigo = limparCodigo(linha[colRet.pedido]);
                if (codigo === "REMESSA" || codigo.includes("PEDIDO") || codigo.includes("N√öMERO")) continue;

                let motorista = linha[colRet.motorista] || "";
                let problema = linha[colRet.problema] || "";
                let cidade = "N/D";
                let entregue = false;
                let isProximo = false; // NOVA VARI√ÅVEL

                const matchBase = mapBase.get(codigo);
                if (matchBase) {
                    if (matchBase.motorista) motorista = String(matchBase.motorista).trim();
                    if (matchBase.cidade) cidade = String(matchBase.cidade).trim();
                    if (matchBase.assinatura && String(matchBase.assinatura).toLowerCase().includes("recebimento com assinatura normal")) {
                        entregue = true;
                    }
                }

                const matchProb = mapProb.get(codigo);
                if (matchProb && matchProb.ultimoMotivo) {
                    problema = matchProb.ultimoMotivo;
                }

                let previsaoData = tratarDataRobustamente(linha[colRet.previsao]);
                let diasRetidos = 0;
                if(previsaoData) {
                    let prevZerada = new Date(previsaoData); prevZerada.setHours(0,0,0,0);
                    diasRetidos = Math.floor((hojeZered - prevZerada) / 86400000);
                    if (diasRetidos < 0) diasRetidos = 0; 
                }

                let statusIPO = ""; let statusTxt = ""; let statusClass = "";
                let infoDevolucao = "-";

                const pLow = String(problema).toLowerCase();
                const semProb = (!problema || problema === "Sem motivo" || problema === "undefined" || problema === "null");
                const semMot = (!motorista || motorista === "N/D" || motorista === "null");

                if (entregue) {
                    statusIPO = "DELIVERED"; statusTxt = "ENTREGUE / CONCLU√çDO"; statusClass = "status-delivered";
                } else if (semProb && semMot) {
                    statusIPO = "FAZER_ATIVO"; statusTxt = "FAZER ATIVO"; statusClass = "status-fazer-ativo";
                } else if (semProb) {
                    statusIPO = "VERIFY_DRIVER"; statusTxt = "VERIFICAR C/ MOTORISTA"; statusClass = "status-driver";
                } else if (pLow.includes("descarte") || pLow.includes("ÂÖ®ÈÉ®ÂºÉÁΩÆ‰ª∂")) {
                    statusIPO = "FINALIZADO"; statusTxt = "DESCARTE / FINALIZADO"; statusClass = "status-descarte";
                } else if (pLow.includes("recusa") || pLow.includes("Êó†ÁêÜÁî±ÊãíÊî∂") || pLow.includes("triagem") || pLow.includes("ÈîôÂàÜ")) {
                    statusIPO = "APTO"; statusTxt = "APTO DEVOLU√á√ÉO IMEDIATA"; statusClass = "status-apto";
                } else if (pLow.includes("insucesso na devolu√ß√£o") || pLow.includes("p‰ªì‰∏çÊàêÂäü") || pLow.includes("ÈÄÄÂõûÂÆ¢Êà∑")) {
                    statusIPO = "INVALID"; statusTxt = "TRATATIVA INV√ÅLIDA"; statusClass = "status-verify";
                } else if (pLow.includes("endere√ßo") || pLow.includes("endereco") || pLow.includes("Âú∞ÂùÄ‰ø°ÊÅØÈîôËØØ") || pLow.includes("impossibilidade") || pLow.includes("Êó†Ê≥ïËøõÂÖ•")) {
                    
                    let dataDoProblema = null;
                    if (matchProb) {
                        let bipesEnd = matchProb.motivos.filter(m => {
                            let mLow = m.motivo.toLowerCase();
                            return mLow.includes("endere√ßo") || mLow.includes("endereco") || mLow.includes("Âú∞ÂùÄ‰ø°ÊÅØÈîôËØØ") || mLow.includes("impossibilidade") || mLow.includes("Êó†Ê≥ïËøõÂÖ•");
                        });
                        if (bipesEnd.length > 0) {
                            bipesEnd.sort((a,b) => a.data - b.data); 
                            dataDoProblema = bipesEnd[0].data;
                        }
                    }

                    if (!dataDoProblema && previsaoData) dataDoProblema = previsaoData; 

                    if (dataDoProblema) {
                        let dataLib = new Date(dataDoProblema.getTime());
                        dataLib.setDate(dataLib.getDate() + 8); 
                        
                        infoDevolucao = `Liberar: ${formatarDataBR(dataLib)}`;
                        
                        if (agora >= dataLib) {
                            statusIPO = "APTO"; statusTxt = "APTO DEVOLU√á√ÉO (8 DIAS)"; statusClass = "status-apto";
                        } else {
                            statusIPO = "WAIT"; statusTxt = "AGUARDANDO PRAZO"; statusClass = "status-wait";
                            // IDENTIFICA SE VENCE NAS PR√ìXIMAS 24H
                            if (dataLib <= amanha) {
                                isProximo = true;
                            }
                        }
                    } else {
                        infoDevolucao = "Sem data de Ref.";
                        statusIPO = "WAIT"; statusTxt = "AGUARDANDO PRAZO"; statusClass = "status-wait";
                    }

                } else if (pLow.includes("aus√™ncia") || pLow.includes("ausencia") || pLow.includes("ÂÆ¢Êà∑‰∏çÂú®")) {
                    
                    let qtd = matchProb ? matchProb.ausencias.size : 1; 
                    if(qtd === 0) qtd = 1; 
                    
                    infoDevolucao = `${qtd} Tentativa(s)`;
                    
                    if (qtd >= 3) {
                        statusIPO = "APTO"; statusTxt = "APTO DEVOLU√á√ÉO (3 TENTATIVAS)"; statusClass = "status-apto";
                    } else {
                        statusIPO = "AUSENCIA"; statusTxt = "AUSENTE / TENTATIVAS"; statusClass = "status-ausencia-proc";
                        // IDENTIFICA SE TEM 2 TENTATIVAS (UM PASSO DE SER DEVOLVIDO)
                        if (qtd === 2) {
                            isProximo = true;
                        }
                    }
                } else {
                    statusIPO = "CHECK_VERIFY"; statusTxt = "VERIFICAR PACOTE"; statusClass = "status-verify";
                }

                if (statusIPO !== "DELIVERED" && statusIPO !== "FINALIZADO") {
                    if (setEtiquetas.has(codigo)) {
                        statusIPO = "IMPRESSA"; 
                        statusTxt = "ETIQUETA IMPRESSA"; 
                        statusClass = "status-impressa";
                    }
                }

                dadosRaw.push({ 
                    codigo, diasRetidos, problema, cidade, 
                    motorista: motorista || "N/D", 
                    statusIPO, statusTxt, statusClass, infoDevolucao, isProximo 
                });
            }

            dadosRaw.sort((a, b) => b.diasRetidos - a.diasRetidos);
            popularFiltrosAuxiliares();
            aplicarFiltros();
        }

        function popularFiltrosAuxiliares() {
            const cidades = [...new Set(dadosRaw.map(d => d.cidade))].filter(Boolean).sort();
            const statusSet = [...new Set(dadosRaw.map(d => d.statusTxt))].filter(Boolean).sort();
            
            const selCid = document.getElementById('filtroCidade');
            const selStat = document.getElementById('filtroStatus');
            
            selCid.innerHTML = '<option value="">Todas</option>';
            selStat.innerHTML = '<option value="">Todos</option>';
            
            cidades.forEach(c => selCid.innerHTML += `<option value="${c}">${c}</option>`);
            statusSet.forEach(s => selStat.innerHTML += `<option value="${s}">${s}</option>`);
        }

        function aplicarFiltros() {
            const busca = document.getElementById('buscaGeral').value.toLowerCase();
            const cid = document.getElementById('filtroCidade').value;
            const stat = document.getElementById('filtroStatus').value;
            
            const vDias = document.getElementById('valorDias').value;
            const opDias = document.getElementById('operadorDias').value;
            
            const chkAtivos = Array.from(document.querySelectorAll('.checkbox-group input:checked')).map(cb => cb.value);

            dadosFiltrados = dadosRaw.filter(d => {
                
                // NOVA L√ìGICA DE FILTRO (Permite ver Vencendo Amanh√£)
                let okCheckbox = false;
                if (chkAtivos.includes(d.statusIPO)) okCheckbox = true;
                if (d.statusIPO === "CHECK_VERIFY" && chkAtivos.includes("INVALID")) okCheckbox = true;
                if (d.isProximo && chkAtivos.includes("PROXIMO")) okCheckbox = true;

                if (!okCheckbox) return false;

                const matchBusca = d.codigo.toLowerCase().includes(busca) || String(d.motorista).toLowerCase().includes(busca);
                const matchCid = cid === "" || d.cidade === cid;
                const matchStat = stat === "" || d.statusTxt === stat;

                let matchDias = true;
                if (vDias !== "") {
                    const val = parseInt(vDias);
                    if (opDias === 'maior') matchDias = d.diasRetidos > val;
                    else if (opDias === 'menor') matchDias = d.diasRetidos < val;
                    else if (opDias === 'igual') matchDias = d.diasRetidos === val;
                }

                return matchBusca && matchCid && matchStat && matchDias;
            });

            atualizarKPIs();
            renderTabela();
            renderTopLists();
        }

        function atualizarKPIs() {
            const setK = (id, fn) => document.getElementById(id).innerText = dadosFiltrados.filter(fn).length;
            document.getElementById('kpiTotal').innerText = dadosFiltrados.length;
            
            setK('kpiImpressa', d => d.statusIPO === 'IMPRESSA');
            setK('kpiApto', d => d.statusIPO === 'APTO');
            setK('kpiProximo', d => d.isProximo); // NOVO KPI
            setK('kpiAtivo', d => d.statusIPO === 'FAZER_ATIVO');
            setK('kpiWait', d => d.statusIPO === 'WAIT');
            setK('kpiAusencia', d => d.statusIPO === 'AUSENCIA');
            setK('kpiDriver', d => d.statusIPO === 'VERIFY_DRIVER');
        }

        function renderTabela() {
            const tb = document.getElementById('tbody');
            tb.innerHTML = "";
            dadosFiltrados.slice(0, 500).forEach(r => {
                const tr = document.createElement('tr');
                let infoHTML = r.infoDevolucao !== "-" ? `<span class="info-pill">${r.infoDevolucao}</span>` : "-";
                
                tr.innerHTML = `
                    <td><strong>${r.codigo}</strong></td>
                    <td style="text-align:center;">${r.diasRetidos}</td>
                    <td><span class="badge ${r.statusClass}">${r.statusTxt}</span></td>
                    <td>${infoHTML}</td>
                    <td style="font-size: 11px;">${r.problema}</td>
                    <td>${r.motorista}</td>
                    <td>${r.cidade}</td>
                `;
                tb.appendChild(tr);
            });
        }

        function renderTopLists() {
            const countCidades = {};
            const countMot = {};
            
            dadosFiltrados.forEach(d => {
                if(d.statusIPO !== 'DELIVERED') { 
                    countCidades[d.cidade] = (countCidades[d.cidade] || 0) + 1;
                    if(d.motorista && d.motorista !== "N/D") {
                        countMot[d.motorista] = (countMot[d.motorista] || 0) + 1;
                    }
                }
            });

            const topCidades = Object.entries(countCidades).sort((a,b)=>b[1]-a[1]).slice(0,10);
            const topMotoristas = Object.entries(countMot).sort((a,b)=>b[1]-a[1]).slice(0,10);

            const divCid = document.getElementById('listaTopCidades');
            divCid.innerHTML = "";
            if(topCidades.length > 0) {
                const max = topCidades[0][1];
                topCidades.forEach(([nome, qtd], i) => divCid.innerHTML += `<div class="rank-row"><div class="rank-name">#${i+1} ${nome}</div><div class="rank-bar-container"><div class="rank-bar bar-blue" style="width:${(qtd/max)*100}%"></div></div><div class="rank-count">${qtd}</div></div>`);
            }

            const divMot = document.getElementById('listaTopMotoristas');
            divMot.innerHTML = "";
            if(topMotoristas.length > 0) {
                const max = topMotoristas[0][1];
                topMotoristas.forEach(([nome, qtd], i) => divMot.innerHTML += `<div class="rank-row"><div class="rank-name">#${i+1} ${nome}</div><div class="rank-bar-container"><div class="rank-bar bar-red" style="width:${(qtd/max)*100}%"></div></div><div class="rank-count">${qtd}</div></div>`);
            }
        }

        function ordenar(k) {
            if (sortCol === k) sortDir = sortDir === 'asc' ? 'desc' : 'asc';
            else { sortCol = k; sortDir = 'asc'; }

            dadosFiltrados.sort((a, b) => {
                let vA = a[k], vB = b[k]; 
                if(typeof vA === 'string'){ vA = vA.toLowerCase(); vB = vB.toLowerCase(); }
                return (vA < vB ? -1 : 1) * (sortDir === 'asc' ? 1 : -1);
            });
            renderTabela();
        }

        function copiarCodigos() {
            if(dadosFiltrados.length === 0) return;
            const t = document.createElement("textarea"); 
            t.value = dadosFiltrados.map(d => d.codigo).join("\n");
            document.body.appendChild(t); t.select(); document.execCommand('copy'); document.body.removeChild(t);
            alert("C√≥digos copiados!");
        }

        function exportarExcel() {
            if(dadosFiltrados.length === 0) return;
            const dt = dadosFiltrados.map(d => ({ 
                "Pedido / Remessa": d.codigo, 
                "Dias Retidos": d.diasRetidos, 
                "Status/Regra": d.statusTxt, 
                "Info Libera√ß√£o/Tentativas": d.infoDevolucao,
                "Motivo Problem√°tico": d.problema, 
                "Motorista": d.motorista, 
                "Cidade": d.cidade 
            }));
            const ws = XLSX.utils.json_to_sheet(dt);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Painel_Operacional");
            XLSX.writeFile(wb, "Dashboard_Logistica_V8.xlsx");
        }
    </script>
</body>
</html>