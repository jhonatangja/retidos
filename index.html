<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard J&T - V41 (CorreÃ§Ã£o Rigorosa DevoluÃ§Ã£o)</title>
    
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary: #d9534f;
            --secondary: #0056b3;
            --warning: #fd7e14;
            --success: #28a745;
            --purple: #6f42c1;
            --info: #17a2b8;
            --dark: #343a40;
            --teal: #009688;
            --delivered: #218838;
            --bg: #f4f6f9;
            --text: #333;
        }

        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; }
        body { background: var(--bg); color: var(--text); padding-bottom: 50px; }

        header {
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: white; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        header h1 { font-size: 22px; display: flex; align-items: center; gap: 10px; }
        header p { font-size: 13px; opacity: 0.9; margin-top: 5px; }

        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }

        .card-upload {
            background: white; padding: 20px; border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px;
            display: flex; gap: 20px; flex-wrap: wrap; align-items: flex-end;
            border-top: 4px solid var(--secondary);
        }
        .input-group { flex: 1; min-width: 200px; }
        .input-group label { display: block; font-weight: 700; margin-bottom: 8px; color: #555; font-size: 11px; text-transform: uppercase; }
        .input-group input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px; }
        
        .btn-main { background: var(--secondary); color: white; border: none; padding: 10px 25px; border-radius: 4px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-main:hover { background: #004494; }

        /* ABAS */
        .nav-tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #ddd; padding-bottom: 10px; }
        .nav-btn {
            background: none; border: none; padding: 10px 20px; cursor: pointer;
            font-size: 16px; font-weight: 600; color: #777; border-radius: 4px; transition: 0.2s;
        }
        .nav-btn:hover { background: #e9ecef; color: #333; }
        .nav-btn.active { background: var(--secondary); color: white; }

        #msgErro {
            background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;
            padding: 15px; border-radius: 6px; margin-bottom: 20px; display: none;
        }

        /* KPIs */
        .kpi-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 20px; }
        .kpi-card { background: white; padding: 15px; border-radius: 6px; border-left: 5px solid #ccc; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .kpi-card h3 { font-size: 10px; text-transform: uppercase; color: #777; margin-bottom: 5px; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .kpi-card .value { font-size: 22px; font-weight: 800; color: #333; }
        
        .border-purple { border-left-color: var(--purple); }
        .border-orange { border-left-color: var(--warning); }
        .border-green { border-left-color: var(--success); }
        .border-red { border-left-color: var(--primary); }
        .border-info { border-left-color: var(--info); }
        .border-dark { border-left-color: var(--dark); }
        .border-teal { border-left-color: var(--teal); }
        .border-del { border-left-color: var(--delivered); }
        .border-gray { border-left-color: #6c757d; }

        /* FILTROS */
        .filters-bar { background: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; gap: 15px; flex-wrap: wrap; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .filter-item { display: flex; flex-direction: column; gap: 5px; margin-right: 15px; }
        .filter-item label { font-size: 11px; font-weight: bold; color: #777; }
        .filter-item input, .filter-item select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; min-width: 150px; }
        
        .days-input-group { display: flex; gap: 5px; }
        .days-input-group select { width: 60px; min-width: 0; }
        .days-input-group input { width: 80px; }

        .checkbox-group { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .checkbox-item { display: flex; align-items: center; gap: 5px; font-size: 13px; background: #f1f3f5; padding: 5px 10px; border-radius: 15px; cursor: pointer; }
        .checkbox-item input { width: auto; margin: 0; cursor: pointer; }

        .main-grid { display: grid; grid-template-columns: 320px 1fr; gap: 20px; align-items: start; }
        .evo-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        @media (max-width: 900px) { .main-grid, .evo-grid { grid-template-columns: 1fr; } }

        .ranking-card { background: white; border-radius: 8px; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); height: 100%; }
        .ranking-header { font-weight: bold; color: #333; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; font-size: 16px; display:flex; align-items:center; gap:8px;}
        .rank-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; font-size: 13px; }
        .rank-name { font-weight: 600; color: #555; width: 50%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .rank-bar-container { flex: 1; background: #f1f1f1; height: 8px; border-radius: 4px; margin: 0 10px; overflow: hidden; }
        .rank-bar { height: 100%; border-radius: 3px; }
        .rank-count { font-weight: bold; color: #333; width: 30px; text-align: right; }
        .bar-blue { background: var(--secondary); }
        .bar-red { background: var(--primary); }

        .table-container { background: white; border-radius: 8px; overflow-x: auto; box-shadow: 0 2px 5px rgba(0,0,0,0.05); padding: 15px; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; min-width: 1000px; }
        th { background: #f1f3f5; padding: 12px; text-align: left; color: #495057; font-weight: 700; cursor: pointer; border-bottom: 2px solid #dee2e6; }
        th:hover { background: #e2e6ea; }
        td { padding: 10px 12px; border-bottom: 1px solid #eee; vertical-align: middle; }
        tr:hover { background-color: #f8f9fa; }

        .badge { padding: 5px 10px; border-radius: 4px; font-weight: bold; font-size: 10px; color: white; display: inline-block; text-transform: uppercase; letter-spacing: 0.5px; }
        .status-apto { background-color: var(--success); }
        .status-jt { background-color: var(--purple); }     
        .status-verify { background-color: var(--warning); } 
        .status-wait { background-color: var(--primary); }
        .status-ausencia-proc { background-color: var(--info); }
        .status-ausencia-plus { background-color: var(--gold); color: white; }
        .status-driver { background-color: var(--dark); }
        .status-returned { background-color: var(--teal); } 
        .status-delivered { background-color: var(--delivered); }
        .evo-ok { color: var(--success); font-weight: bold; }
        .evo-pend { color: var(--primary); font-weight: bold; }

        .btn-action { background: #17a2b8; color: white; border: none; padding: 6px 15px; border-radius: 4px; cursor: pointer; font-size: 12px; margin-left: 5px; }
        .btn-excel { background: #218838; }
        .btn-cobranca { background: #fd7e14; color: white; font-weight: bold; }
        .btn-city { background: #6f42c1; color: white; font-weight: bold; }

        /* MODAL */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 10000;
            display: none; justify-content: center; align-items: center;
        }
        .modal-content {
            background: white; padding: 25px; border-radius: 8px; width: 600px; max-width: 90%;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .modal-header { font-size: 18px; font-weight: bold; margin-bottom: 15px; display: flex; justify-content: space-between; }
        .close-btn { cursor: pointer; color: #aaa; font-size: 20px; }
        .modal-body textarea { width: 100%; height: 350px; padding: 10px; margin-top: 10px; border: 1px solid #ccc; border-radius: 4px; resize: none; font-family: monospace; font-size: 12px; }
        
        #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--secondary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hidden { display: none !important; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
    </style>
</head>
<body>

    <div id="loadingOverlay" class="hidden">
        <div class="spinner"></div>
        <h3>Processando...</h3>
        <p style="color:#666; font-size:12px;">Verificando Input 5 (Devolvido) vs Input 2 (Base)</p>
    </div>

    <div id="modalCobranca" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <span><i class="fa-brands fa-whatsapp"></i> Gerar Mensagem</span>
                <span class="close-btn" onclick="fecharModalCobranca()">&times;</span>
            </div>
            <div class="modal-body">
                <label id="lblCobrancaAlvo">Selecione:</label>
                <select id="selCobrancaTarget" style="width: 100%; padding: 8px; margin-bottom: 10px;">
                    <option value="">-- Selecione --</option>
                </select>
                <input type="hidden" id="modoCobranca" value="">
                
                <textarea id="txtAreaCobranca"></textarea>
                <button class="btn-main" style="width: 100%; margin-top: 10px;" onclick="copiarTextoCobranca()">
                    <i class="fa-regular fa-copy"></i> Copiar Texto
                </button>
            </div>
        </div>
    </div>

    <header>
        <div class="container" style="padding: 0;">
            <h1><i class="fa-solid fa-boxes-packing"></i> Dashboard J&T - V41</h1>
            <p>Status "DEVOLVIDO" exige presenÃ§a no Input 5 + Data > AÃ§Ã£o Rua</p>
        </div>
    </header>

    <div class="container">
        
        <div class="card-upload">
            <div class="input-group">
                <label>1. Planilha RETIDOS (A-R-T)</label>
                <input type="file" id="fileRetidos" accept=".csv, .xlsx, .xls">
            </div>
            <div class="input-group">
                <label>2. Base DETALHADA (O=SaÃ­da, R=Prob)</label>
                <input type="file" id="fileBase" accept=".csv, .xlsx, .xls">
            </div>
            <div class="input-group">
                <label>3. GESTÃƒO ENTREGUES (EvoluÃ§Ã£o + Baixa)</label>
                <input type="file" id="fileEvolucao" accept=".csv, .xlsx, .xls">
            </div>
            <div class="input-group">
                <label>4. COMPLEMENTO (A/E/T/U/V)</label>
                <input type="file" id="fileComplemento" accept=".csv, .xlsx, .xls">
            </div>
            <div class="input-group">
                <label>5. BIPE DEVOLUÃ‡ÃƒO (ObrigatÃ³rio p/ Devolvidos)</label>
                <input type="file" id="fileDevolucao" accept=".csv, .xlsx, .xls">
            </div>
            <button class="btn-main" onclick="tratarClickCarregar()">
                <i class="fa-solid fa-play"></i> Carregar Tudo
            </button>
        </div>

        <div id="msgErro"></div>

        <div class="nav-tabs" id="navTabs" style="display:none;">
            <button class="nav-btn active" onclick="mudarAba('ops')"><i class="fa-solid fa-list-check"></i> Painel Operacional</button>
            <button class="nav-btn" onclick="mudarAba('evo')"><i class="fa-solid fa-chart-line"></i> Painel EvoluÃ§Ã£o</button>
        </div>

        <div id="tabOps" class="tab-content active">
            
            <div class="filters-bar" style="flex-direction:column; align-items:flex-start;">
                <div style="display:flex; width:100%; gap:15px; margin-bottom:15px; flex-wrap:wrap;">
                    <div class="filter-item" style="flex: 1;"><label>Busca</label><input type="text" id="buscaGeral" placeholder="Pedido/Motorista..." onkeyup="aplicarFiltros()"></div>
                    <div class="filter-item"><label>Dias Retidos</label>
                        <div class="days-input-group">
                            <select id="operadorDias" onchange="aplicarFiltros()"><option value="maior">></option><option value="menor"><</option><option value="igual">=</option></select>
                            <input type="number" id="valorDias" placeholder="Ex: 10" onkeyup="aplicarFiltros()">
                        </div>
                    </div>
                    <div class="filter-item" style="flex: 1;"><label>Cidade</label><select id="filtroCidade" onchange="aplicarFiltros()"><option value="">Todas</option></select></div>
                    <div class="filter-item" style="flex: 1.5;"><label>ProblemÃ¡tica</label><select id="filtroProblema" onchange="aplicarFiltros()"><option value="">Todas</option></select></div>
                    <div class="filter-item" style="flex: 1.5;"><label>Status</label><select id="filtroStatus" onchange="aplicarFiltros()"><option value="">Todos</option></select></div>
                </div>
                <div class="filter-item" style="width:100%;">
                    <label style="margin-bottom:8px; display:block;">Exibir Grupos:</label>
                    <div class="checkbox-group">
                        <label class="checkbox-item"><input type="checkbox" checked onchange="aplicarFiltros()" value="DELIVERED"> ðŸŸ¢ JÃ¡ Entregues</label>
                        <label class="checkbox-item"><input type="checkbox" checked onchange="aplicarFiltros()" value="RETURNED_BASE"> ðŸŸ¢ JÃ¡ Devolvidos</label>
                        <label class="checkbox-item"><input type="checkbox" checked onchange="aplicarFiltros()" value="AUSENCIA_PROCESS"> ðŸ”µ Proc. AusÃªncia</label>
                        <label class="checkbox-item"><input type="checkbox" checked onchange="aplicarFiltros()" value="AUSENCIA_PLUS"> ðŸŸ¡ Ausente +1</label>
                        <label class="checkbox-item"><input type="checkbox" checked onchange="aplicarFiltros()" value="APTO"> ðŸŸ¢ Aptos</label>
                        <label class="checkbox-item"><input type="checkbox" checked onchange="aplicarFiltros()" value="WAIT"> ðŸ”´ Aguardando</label>
                        <label class="checkbox-item"><input type="checkbox" checked onchange="aplicarFiltros()" value="VERIFY_DRIVER"> âš« Verif. Motorista</label>
                        <label class="checkbox-item"><input type="checkbox" checked onchange="aplicarFiltros()" value="CHECK_JT"> ðŸŸ£ Verif. J&T</label>
                        <label class="checkbox-item"><input type="checkbox" checked onchange="aplicarFiltros()" value="CHECK_VERIFY"> ðŸŸ  Verificar Outros</label>
                    </div>
                </div>
            </div>

            <div class="kpi-row">
                <div class="kpi-card border-gray"><h3>Listados</h3><div class="value" id="kpiTotal">0</div></div>
                <div class="kpi-card border-del"><h3>JÃ¡ Entregues</h3><div class="value" id="kpiEntregues">0</div></div>
                <div class="kpi-card border-teal"><h3>JÃ¡ Devolvidos</h3><div class="value" id="kpiDevolvidos">0</div></div>
                <div class="kpi-card border-info"><h3>Proc. AusÃªncia</h3><div class="value" id="kpiAusenciaProc">0</div></div>
                <div class="kpi-card border-gold"><h3>Ausente +1</h3><div class="value" id="kpiAusenciaPlus">0</div></div>
                <div class="kpi-card border-green"><h3>Aptos DevoluÃ§Ã£o</h3><div class="value" id="kpiApto">0</div></div>
                <div class="kpi-card border-red"><h3>Aguardando Prazo</h3><div class="value" id="kpiWait">0</div></div>
                <div class="kpi-card border-dark"><h3>Verif. Motorista</h3><div class="value" id="kpiDriver">0</div></div>
                <div class="kpi-card border-purple"><h3>J&T / Outros</h3><div class="value" id="kpiOutros">0</div></div>
            </div>

            <div class="main-grid">
                <div class="sidebar">
                    <div class="ranking-card"><div class="ranking-header">Top 10 Cidades</div><div id="listaTopCidades"></div></div>
                    <div class="ranking-card"><div class="ranking-header">Top 10 Problemas</div><div id="listaTopProblemas"></div></div>
                </div>
                <div class="table-container">
                    <div style="display: flex; justify-content: space-between; align-items:center; margin-bottom: 15px;">
                        <h3>Listagem de Pedidos</h3>
                        <div>
                            <button class="btn-action btn-cobranca" onclick="abrirModalCobranca('motorista')"><i class="fa-solid fa-user"></i> Cobrar Motorista</button>
                            <button class="btn-action btn-city" onclick="abrirModalCobranca('cidade')"><i class="fa-solid fa-city"></i> Cobrar Cidade (Grupo)</button>
                            <button class="btn-action" onclick="copiarCodigos()"><i class="fa-regular fa-copy"></i> Copiar</button>
                            <button class="btn-action btn-excel" onclick="exportarExcel('ops')"><i class="fa-solid fa-file-excel"></i> Exportar</button>
                        </div>
                    </div>
                    <table id="tabelaDados">
                        <thead>
                            <tr>
                                <th onclick="ordenar('codigo')">Pedido</th>
                                <th onclick="ordenar('diasRetidos')">Dias</th>
                                <th onclick="ordenar('statusTxt')">Status</th>
                                <th onclick="ordenar('destinatario')">DestinatÃ¡rio</th>
                                <th onclick="ordenar('problema')">ProblemÃ¡tica</th>
                                <th onclick="ordenar('motorista')">Motorista</th>
                                <th onclick="ordenar('cidade')">Cidade</th>
                            </tr>
                        </thead>
                        <tbody id="tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="tabEvo" class="tab-content">
            <div class="kpi-row" style="grid-template-columns: repeat(4, 1fr);">
                <div class="kpi-card border-gray"><h3>Base Retidos (Planilha 1)</h3><div class="value" id="evoBaseTotal">0</div></div>
                <div class="kpi-card border-green"><h3>Recuperados</h3><div class="value" id="evoRecuperados">0</div></div>
                <div class="kpi-card border-red"><h3>Pendentes</h3><div class="value" id="evoPendentes">0</div></div>
                <div class="kpi-card border-info"><h3>EficiÃªncia</h3><div class="value" id="evoEficiencia">0%</div></div>
            </div>
            <div class="evo-grid">
                <div class="ranking-card" style="border-top: 4px solid var(--success);">
                    <div class="ranking-header"><i class="fa-solid fa-truck-fast"></i> TOP 5 RECUPERADORES</div>
                    <div id="evoTopMotoristas" style="padding: 10px 0;"></div>
                </div>
                <div class="ranking-card" style="border-top: 4px solid var(--secondary);">
                    <div class="ranking-header"><i class="fa-solid fa-map-location-dot"></i> TOP 5 CIDADES RECUPERADAS</div>
                    <div id="evoTopCidades" style="padding: 10px 0;"></div>
                </div>
            </div>
            <div class="table-container">
                <div style="display: flex; justify-content: space-between; align-items:center; margin-bottom: 15px;">
                    <h3>RelatÃ³rio EvoluÃ§Ã£o</h3>
                    <button class="btn-action btn-excel" onclick="exportarExcel('evo')"><i class="fa-solid fa-file-excel"></i> Exportar</button>
                </div>
                <table id="tabelaEvo">
                    <thead>
                        <tr>
                            <th onclick="ordenarEvo('codigo')">Pedido</th>
                            <th onclick="ordenarEvo('statusEvo')">SituaÃ§Ã£o</th>
                            <th onclick="ordenarEvo('diasRetidos')">Dias Ret.</th>
                            <th onclick="ordenarEvo('motorista')">Motorista</th>
                            <th onclick="ordenarEvo('cidade')">Cidade</th>
                            <th onclick="ordenarEvo('problema')">ProblemÃ¡tica</th>
                        </tr>
                    </thead>
                    <tbody id="tbodyEvo"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const IDX_RETIDOS = { pedido: 0, motivo: 17, dias: 19 };
        const IDX_BASE = { pedido: 0, saida: 14, motorista: 15, problema_time: 17, cidade: 29 };
        const IDX_COMPLEMENTO = { pedido: 0, motorista: 4, cidade: 19, motivo: 20, destinatario: 21, tsJ: 9, tsQ: 16 };
        const IDX_DEVOLUCAO = { pedido: 0, data: 4 }; // Confirme se a data estÃ¡ na coluna E (indice 4) da planilha DEVOLVIDO.xlsx
        const IDX_EVO = { pedido: 0, motorista: 4, cidade: 19 }; 

        const REGRA_DIAS = 9;
        const STRINGS_JT = ["aguardando.janela", "é€€å›žä»¶å¾…å®¢æˆ·å®¡æ ¸"];
        const TARGET_DRIVERS = ["FRQDO-JHONATAN ALVES SILVA", "FRQDO-FELIPE LOMBRE MUNDIM"];

        let dadosRaw = [];
        let dadosFiltrados = [];
        let dadosEvolucaoDetalhados = []; 
        let setRetidosOriginais = new Set(); 

        function mudarAba(aba) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
            document.getElementById('tab' + (aba === 'ops' ? 'Ops' : 'Evo')).classList.add('active');
            event.target.classList.add('active');
        }

        function lerArquivo(arquivo) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const wb = XLSX.read(e.target.result, { type: 'array' });
                        const sheet = wb.Sheets[wb.SheetNames[0]];
                        resolve(XLSX.utils.sheet_to_json(sheet, { header: 1 }));
                    } catch (err) { reject(err); }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(arquivo);
            });
        }

        function tratarClickCarregar() {
            const fRetidos = document.getElementById('fileRetidos').files[0];
            const fBase = document.getElementById('fileBase').files[0];
            const fEvo = document.getElementById('fileEvolucao').files[0]; // Input 3 (Entregues + EvoluÃ§Ã£o)
            const fComp = document.getElementById('fileComplemento').files[0];
            const fDev = document.getElementById('fileDevolucao').files[0];
            
            const divErro = document.getElementById('msgErro');
            divErro.style.display = 'none'; divErro.innerHTML = '';

            if(!fRetidos || !fBase) {
                mostrarErro("As planilhas 1 (Retidos) e 2 (Base) sÃ£o obrigatÃ³rias.");
                return;
            }

            document.getElementById('loadingOverlay').classList.remove('hidden');

            setTimeout(async () => {
                try {
                    const retidos = await lerArquivo(fRetidos);
                    const base = await lerArquivo(fBase);
                    
                    let entregues = null;
                    if(fEvo) entregues = await lerArquivo(fEvo); // Ler input 3

                    let complemento = null;
                    if(fComp) complemento = await lerArquivo(fComp);

                    let devolvidos = null;
                    if(fDev) devolvidos = await lerArquivo(fDev);

                    processarLogica(retidos, base, complemento, devolvidos, entregues);

                    if(entregues) {
                        processarEvolucao(entregues);
                    } else {
                        dadosEvolucaoDetalhados = [];
                        renderEvolucao({ motoristas: [], cidades: [], kpis: { total: setRetidosOriginais.size, rec: 0, pen: setRetidosOriginais.size } });
                    }

                    document.getElementById('navTabs').style.display = 'flex';

                } catch (error) {
                    console.error(error);
                    mostrarErro("Erro: " + error.message);
                } finally {
                    document.getElementById('loadingOverlay').classList.add('hidden');
                }
            }, 200);
        }

        function mostrarErro(msg) {
            const div = document.getElementById('msgErro');
            div.innerHTML = `<i class="fa-solid fa-triangle-exclamation"></i> ${msg}`;
            div.style.display = 'block';
        }

        function limparCodigo(val) {
            if (!val) return "";
            return String(val).trim().toUpperCase().replace(/[\s\-\.]/g, "");
        }

        function processarLogica(retidos, base, complemento, devolvidos, entregues) {
            setRetidosOriginais.clear(); 

            // 1. Mapear Entregues (Input 3)
            const setEntregues = new Set();
            if(entregues) {
                for(let i=1; i < entregues.length; i++) {
                    const row = entregues[i];
                    if(row && row.length > 0) {
                        const code = limparCodigo(row[IDX_EVO.pedido]);
                        if(code) setEntregues.add(code);
                    }
                }
            }

            // 2. Mapear Base (Backup de Datas)
            const mapBase = new Map();
            for(let i=1; i < base.length; i++) {
                const linha = base[i];
                if (!linha || linha.length === 0) continue;
                const rawPed = linha[IDX_BASE.pedido];
                if (!rawPed) continue;
                mapBase.set(limparCodigo(rawPed), {
                    dataSaida: parseData(linha[IDX_BASE.saida]),
                    dataProblema: parseData(linha[IDX_BASE.problema_time]),
                    cidade: linha[IDX_BASE.cidade],
                    motorista: linha[IDX_BASE.motorista]
                });
            }

            // 3. Mapear Complemento (Texto)
            const mapComp = new Map();
            if(complemento) {
                for(let i=1; i < complemento.length; i++) {
                    const linha = complemento[i];
                    if (!linha || linha.length === 0) continue;
                    const rawPed = linha[IDX_COMPLEMENTO.pedido];
                    if (!rawPed) continue;
                    mapComp.set(limparCodigo(rawPed), {
                        motorista: linha[IDX_COMPLEMENTO.motorista],
                        cidade: linha[IDX_COMPLEMENTO.cidade],
                        motivo: linha[IDX_COMPLEMENTO.motivo],
                        destinatario: linha[IDX_COMPLEMENTO.destinatario],
                        // REMOVIDO USO DE COLUNA J E Q PARA DEFINIR "DEVOLVIDO"
                        // tsJ: parseData(linha[IDX_COMPLEMENTO.tsJ]),
                        // tsQ: parseData(linha[IDX_COMPLEMENTO.tsQ])
                    });
                }
            }

            // 4. Mapear Devolvidos (Input 5 - OBRIGATÃ“RIO)
            const mapDev = new Map();
            if(devolvidos) {
                for(let i=1; i < devolvidos.length; i++) {
                    const linha = devolvidos[i];
                    if (!linha || linha.length === 0) continue;
                    const rawPed = linha[IDX_DEVOLUCAO.pedido];
                    if (!rawPed) continue;
                    const dataDev = parseData(linha[IDX_DEVOLUCAO.data]);
                    if(dataDev) mapDev.set(limparCodigo(rawPed), dataDev);
                }
            }

            dadosRaw = [];

            // 5. Cruzar
            for(let i=1; i < retidos.length; i++) {
                const linha = retidos[i];
                if (!linha || linha.length === 0) continue;
                const codigo = limparCodigo(linha[IDX_RETIDOS.pedido]);
                if (codigo === "REMESSA" || codigo === "PEDIDO") continue;

                setRetidosOriginais.add(codigo);

                let rawDias = linha[IDX_RETIDOS.dias];
                let diasRetidos = 0;
                if (typeof rawDias === 'number') diasRetidos = rawDias;
                else {
                    const strDias = String(rawDias || "");
                    const match = strDias.match(/(\d+)/); 
                    if (match) diasRetidos = parseInt(match[1]);
                }

                let problema = String(linha[IDX_RETIDOS.motivo] || "").trim();
                
                const matchBase = mapBase.get(codigo);
                const matchComp = mapComp.get(codigo);

                let cidade = "N/D";
                let motorista = "N/D";
                let destinatario = "NÃ£o Identificado";
                
                if(matchComp) {
                    if (matchComp.motorista) motorista = String(matchComp.motorista).trim();
                    if (matchComp.cidade) cidade = matchComp.cidade;
                    if (matchComp.destinatario) destinatario = matchComp.destinatario;
                    if ((!problema || problema === "Sem motivo") && matchComp.motivo) problema = matchComp.motivo;
                } else if(matchBase) {
                    if (matchBase.cidade) cidade = matchBase.cidade;
                    if (matchBase.motorista) motorista = String(matchBase.motorista).trim();
                }

                // --- LÃ“GICA DE STATUS ---
                let statusIPO = "CHECK_VERIFY";
                let statusTxt = "VERIFICAR";
                let statusClass = "status-verify";
                
                // 1. CHECAGEM DE ENTREGUE
                if (setEntregues.has(codigo)) {
                    statusIPO = "DELIVERED";
                    statusTxt = "JÃ ENTREGUE (BAIXA)";
                    statusClass = "status-delivered";
                } else {
                    // 2. CHECAGEM DE DEVOLUÃ‡ÃƒO (CORRIGIDA)
                    
                    // SÃ³ Ã© devolvido se ESTIVER no Input 5 (mapDev)
                    const dataRetornoBase = mapDev.get(codigo); // Data do Input 5

                    let devolvidoConfirmado = false;

                    if (dataRetornoBase) { // Apenas se existir no relatÃ³rio de devoluÃ§Ã£o
                        const dtSaida = matchBase ? matchBase.dataSaida : null; 
                        const dtProblema = matchBase ? matchBase.dataProblema : null;
                        
                        // Ãšltima aÃ§Ã£o na rua
                        let ultimaAcaoRua = null;
                        if (dtSaida && dtProblema) ultimaAcaoRua = dtSaida > dtProblema ? dtSaida : dtProblema;
                        else ultimaAcaoRua = dtSaida || dtProblema;

                        if (!ultimaAcaoRua) {
                            devolvidoConfirmado = true; // Tem bip de devoluÃ§Ã£o e nenhuma saÃ­da registrada recente
                        } else {
                            // Se bip de devoluÃ§Ã£o for MAIOR que a saÃ­da, confirma.
                            if (dataRetornoBase > ultimaAcaoRua) {
                                devolvidoConfirmado = true;
                            }
                        }
                    }

                    if (devolvidoConfirmado) {
                        statusIPO = "RETURNED_BASE"; statusTxt = "JÃ DEVOLVIDO"; statusClass = "status-returned";
                    } else {
                        // LÃ³gica PadrÃ£o de Status
                        const pLow = problema.toLowerCase();
                        const mUp = motorista.toUpperCase();

                        if (!problema || problema === "Sem motivo") {
                            statusIPO = "VERIFY_DRIVER"; statusTxt = "VERIFICAR COM MOTORISTA"; statusClass = "status-driver";
                        } else if (pLow.includes("recusa")) {
                            statusIPO = "APTO"; statusTxt = "APTO DEVOLUÃ‡ÃƒO"; statusClass = "status-apto";
                        } else if (pLow.includes("ausÃªncia") || pLow.includes("ausencia")) {
                            if (TARGET_DRIVERS.some(d => mUp.includes(d))) {
                                statusIPO = "AUSENCIA_PROCESS"; statusTxt = "EM PROCESSO DE LANÃ‡AMENTO"; statusClass = "status-ausencia-proc";
                            } else {
                                statusIPO = "AUSENCIA_PLUS"; statusTxt = "AUSENTE +1 TENTATIVA"; statusClass = "status-ausencia-plus";
                            }
                        } else if (pLow.includes("endereÃ§o") || pLow.includes("impossibilidade")) {
                            statusIPO = "WAIT"; statusTxt = "AGUARDANDO PRAZO"; statusClass = "status-wait";
                        } else {
                            if (STRINGS_JT.some(k => pLow.includes(k))) {
                                statusIPO = "CHECK_JT"; statusTxt = "VERIFICAR COM J&T"; statusClass = "status-jt";
                            } else if (diasRetidos > REGRA_DIAS) { 
                                statusIPO = "APTO"; statusTxt = "APTO DEVOLUÃ‡ÃƒO"; statusClass = "status-apto";
                            } else {
                                statusIPO = "CHECK_VERIFY"; statusTxt = "VERIFICAR"; statusClass = "status-verify";
                            }
                        }
                    }
                }

                dadosRaw.push({ codigo, diasRetidos, problema, cidade, motorista, destinatario, statusIPO, statusTxt, statusClass });
            }

            dadosRaw.sort((a, b) => b.diasRetidos - a.diasRetidos);
            popularFiltrosAuxiliares();
            aplicarFiltros();
        }

        // --- LÃ“GICA EVOLUÃ‡ÃƒO ---
        function processarEvolucao(data) {
            const countMot = {}; const countCid = {}; let recuperadosCount = 0;
            const setRecuperados = new Set();
            for(let i=1; i < data.length; i++) {
                const linha = data[i]; if(!linha || linha.length === 0) continue;
                const codigo = limparCodigo(linha[IDX_EVO.pedido]);
                if (setRetidosOriginais.has(codigo)) {
                    recuperadosCount++;
                    setRecuperados.add(codigo);
                    const mot = String(linha[IDX_EVO.motorista] || "N/D").trim().toUpperCase();
                    const cid = String(linha[IDX_EVO.cidade] || "N/D").trim().toUpperCase();
                    if(mot !== "N/D") countMot[mot] = (countMot[mot] || 0) + 1;
                    if(cid !== "N/D") countCid[cid] = (countCid[cid] || 0) + 1;
                }
            }
            dadosEvolucaoDetalhados = dadosRaw.map(r => {
                const entregue = setRecuperados.has(r.codigo);
                return { codigo: r.codigo, motorista: r.motorista, cidade: r.cidade, problema: r.problema, diasRetidos: r.diasRetidos, statusEvo: entregue ? "ENTREGUE" : "PENDENTE", classeEvo: entregue ? "evo-ok" : "evo-pend" };
            });
            dadosEvolucaoDetalhados.sort((a,b) => (a.statusEvo === b.statusEvo) ? b.diasRetidos - a.diasRetidos : (a.statusEvo === "PENDENTE" ? -1 : 1));
            const topMot = Object.entries(countMot).sort((a,b) => b[1] - a[1]).slice(0, 5);
            const topCid = Object.entries(countCid).sort((a,b) => b[1] - a[1]).slice(0, 5);
            renderEvolucao({ motoristas: topMot, cidades: topCid, kpis: { total: setRetidosOriginais.size, rec: recuperadosCount, pen: setRetidosOriginais.size - recuperadosCount } });
            renderTabelaEvo();
        }

        // --- MENSAGENS E MODAL ---
        function abrirModalCobranca(modo) {
            document.getElementById('modoCobranca').value = modo;
            const sel = document.getElementById('selCobrancaTarget');
            const lbl = document.getElementById('lblCobrancaAlvo');
            const txt = document.getElementById('txtAreaCobranca');
            sel.innerHTML = '<option value="">-- Selecione --</option>';
            txt.value = "";

            if (modo === 'motorista') {
                lbl.innerText = "Selecione o Motorista:";
                const motoristas = [...new Set(dadosRaw.map(d => d.motorista))].filter(m => m && m !== "N/D").sort();
                motoristas.forEach(m => sel.innerHTML += `<option value="${m}">${m}</option>`);
            } else {
                lbl.innerText = "Selecione a Cidade:";
                const cidades = [...new Set(dadosRaw.map(d => d.cidade))].filter(c => c && c !== "N/D").sort();
                cidades.forEach(c => sel.innerHTML += `<option value="${c}">${c}</option>`);
            }
            sel.onchange = function() { if(modo === 'motorista') gerarTextoCobrancaMotorista(); else gerarTextoCobrancaCidade(); };
            document.getElementById('modalCobranca').style.display = 'flex';
        }

        function fecharModalCobranca() { document.getElementById('modalCobranca').style.display = 'none'; }

        function gerarTextoCobrancaMotorista() {
            const motorista = document.getElementById('selCobrancaTarget').value;
            if(!motorista) return;
            const pendencias = dadosRaw.filter(d => 
                d.motorista === motorista && 
                d.statusIPO !== 'APTO' && 
                d.statusIPO !== 'RETURNED_BASE' &&
                d.statusIPO !== 'DELIVERED' // Ignora jÃ¡ entregues
            );
            if(pendencias.length === 0) { document.getElementById('txtAreaCobranca').value = "Nenhuma pendÃªncia."; return; }
            let texto = `*OLÃ ${motorista}!*\n\nConstam *${pendencias.length}* pacotes pendentes:\n\n`;
            pendencias.forEach(p => texto += `ðŸ“¦ *${p.codigo}* (${p.diasRetidos} dias)\nðŸ‘¤ ${p.destinatario}\nâš ï¸ ${p.problema}\nðŸ“ ${p.cidade}\n\n`);
            texto += "Favor regularizar.";
            document.getElementById('txtAreaCobranca').value = texto;
        }

        function gerarTextoCobrancaCidade() {
            const cidade = document.getElementById('selCobrancaTarget').value;
            if(!cidade) return;
            
            // FILTRO NOVO: Apenas >= 3 dias E nÃ£o Entregue/Devolvido
            const pendencias = dadosRaw.filter(d => 
                d.cidade === cidade && 
                d.statusIPO !== 'APTO' && 
                d.statusIPO !== 'RETURNED_BASE' &&
                d.statusIPO !== 'DELIVERED' && 
                d.diasRetidos >= 3
            );

            if(pendencias.length === 0) {
                document.getElementById('txtAreaCobranca').value = "Nenhuma pendÃªncia acima de 3 dias nesta cidade.";
                return;
            }

            const porMotorista = {};
            pendencias.forEach(p => {
                const mot = p.motorista || "SEM MOTORISTA";
                if(!porMotorista[mot]) porMotorista[mot] = [];
                porMotorista[mot].push(p);
            });

            let texto = `ðŸš¨ *COBRANÃ‡A DE PENDÃŠNCIAS - ${cidade.toUpperCase()}* ðŸš¨\n\n`;
            texto += `âš ï¸ *ATENÃ‡ÃƒO:* Pedidos acima de *5 dias* retidos sÃ£o extraviados automaticamente pela J&T!\n`;
            texto += `PeÃ§o *urgÃªncia* na verificaÃ§Ã£o destes casos.\n\n`;
            texto += `--------------------------------\n\n`;

            Object.keys(porMotorista).sort().forEach(mot => {
                const lista = porMotorista[mot];
                texto += `ðŸ‘¤ *${mot}*\n`;
                lista.forEach(p => {
                    texto += `ðŸ“¦ ${p.codigo} (*${p.diasRetidos} dias*) - ${p.destinatario.substring(0, 25)}\n`;
                });
                texto += `\n`;
            });

            texto += `--------------------------------\n`;
            texto += `â“ *Qualquer dÃºvida, consultar a base.*`;

            document.getElementById('txtAreaCobranca').value = texto;
        }

        function copiarTextoCobranca() { document.getElementById('txtAreaCobranca').select(); document.execCommand('copy'); alert("Copiado!"); }

        // --- UTILS ---
        function renderEvolucao(d) {
            document.getElementById('evoBaseTotal').innerText = d.kpis.total;
            document.getElementById('evoRecuperados').innerText = d.kpis.rec;
            document.getElementById('evoPendentes').innerText = d.kpis.pen;
            document.getElementById('evoEficiencia').innerText = (d.kpis.total > 0 ? ((d.kpis.rec / d.kpis.total)*100).toFixed(1) : 0) + "%";
            const elMot = document.getElementById('evoTopMotoristas'); elMot.innerHTML = "";
            const elCid = document.getElementById('evoTopCidades'); elCid.innerHTML = "";
            if(d.motoristas.length > 0) { const max = d.motoristas[0][1]; d.motoristas.forEach(([n,q], i) => elMot.innerHTML += `<div class="rank-row"><div class="rank-name">#${i+1} ${n}</div><div class="rank-bar-container"><div class="rank-bar bar-green" style="width:${(q/max)*100}%"></div></div><div class="rank-count">${q}</div></div>`); }
            if(d.cidades.length > 0) { const max = d.cidades[0][1]; d.cidades.forEach(([n,q], i) => elCid.innerHTML += `<div class="rank-row"><div class="rank-name">#${i+1} ${n}</div><div class="rank-bar-container"><div class="rank-bar bar-blue" style="width:${(q/max)*100}%"></div></div><div class="rank-count">${q}</div></div>`); }
        }
        function renderTabelaEvo() {
            const tb = document.getElementById('tbodyEvo'); tb.innerHTML = "";
            dadosEvolucaoDetalhados.slice(0,500).forEach(r => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${r.codigo}</td><td class="${r.classeEvo}">${r.statusEvo}</td><td>${r.diasRetidos}</td><td>${r.motorista}</td><td>${r.cidade}</td><td style="font-size:11px">${r.problema}</td>`;
                tb.appendChild(tr);
            });
        }
        function parseData(val) {
            if (!val) return null;
            if (val instanceof Date) return val;
            if (typeof val === 'number') return new Date(Math.round((val - 25569) * 86400 * 1000));
            if (typeof val === 'string') {
                if (val.match(/^\d{4}-\d{2}-\d{2}/)) return new Date(val);
                if (val.includes('/')) { const p = val.split(' ')[0].split('/'); if(p.length===3) return new Date(p[2], p[1]-1, p[0]); }
                if (val.includes(':')) return new Date(val);
            }
            return new Date(val);
        }
        function popularFiltrosAuxiliares() {
            const c = new Set(), p = new Set(), s = new Set();
            dadosRaw.forEach(d => { if(d.cidade!=="N/D") c.add(d.cidade); if(d.problema) p.add(d.problema); if(d.statusTxt) s.add(d.statusTxt); });
            const selC = document.getElementById('filtroCidade'), selP = document.getElementById('filtroProblema'), selS = document.getElementById('filtroStatus');
            selC.innerHTML = '<option value="">Todas</option>'; Array.from(c).sort().forEach(x => selC.innerHTML+=`<option value="${x}">${x}</option>`);
            selP.innerHTML = '<option value="">Todas</option>'; Array.from(p).sort().forEach(x => selP.innerHTML+=`<option value="${x}">${x.substring(0,60)}</option>`);
            selS.innerHTML = '<option value="">Todos</option>'; Array.from(s).sort().forEach(x => selS.innerHTML+=`<option value="${x}">${x}</option>`);
        }
        function aplicarFiltros() {
            const busca = document.getElementById('buscaGeral').value.toLowerCase();
            const fC = document.getElementById('filtroCidade').value, fP = document.getElementById('filtroProblema').value, fS = document.getElementById('filtroStatus').value;
            const opD = document.getElementById('operadorDias').value, vD = document.getElementById('valorDias').value;
            const chk = Array.from(document.querySelectorAll('.checkbox-item input:checked')).map(x => x.value);
            dadosFiltrados = dadosRaw.filter(d => {
                const txt = d.codigo.toLowerCase().includes(busca) || d.motorista.toLowerCase().includes(busca);
                const st = chk.includes(d.statusIPO);
                const city = fC ? d.cidade === fC : true;
                const prob = fP ? d.problema === fP : true;
                const stat = fS ? d.statusTxt === fS : true;
                let dias = true;
                if(vD !== "") { const v = parseInt(vD); dias = opD==="maior" ? d.diasRetidos > v : (opD==="menor" ? d.diasRetidos < v : d.diasRetidos === v); }
                return txt && st && city && prob && stat && dias;
            });
            atualizarKPIs(); renderTabela(); renderTopLists();
        }
        function atualizarKPIs() {
            const setK = (id, fn) => document.getElementById(id).innerText = dadosFiltrados.filter(fn).length;
            document.getElementById('kpiTotal').innerText = dadosFiltrados.length;
            setK('kpiEntregues', d => d.statusIPO === 'DELIVERED');
            setK('kpiDevolvidos', d => d.statusIPO === 'RETURNED_BASE');
            setK('kpiAusenciaProc', d => d.statusIPO === 'AUSENCIA_PROCESS');
            setK('kpiAusenciaPlus', d => d.statusIPO === 'AUSENCIA_PLUS');
            setK('kpiApto', d => d.statusIPO === 'APTO');
            setK('kpiWait', d => d.statusIPO === 'WAIT');
            setK('kpiDriver', d => d.statusIPO === 'VERIFY_DRIVER');
            setK('kpiOutros', d => ['CHECK_JT', 'CHECK_VERIFY'].includes(d.statusIPO));
        }
        function renderTabela() {
            const tb = document.getElementById('tbody'); tb.innerHTML = "";
            dadosFiltrados.slice(0,500).forEach(r => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td><b>${r.codigo}</b></td><td style="font-weight:bold;">${r.diasRetidos}</td><td><span class="badge ${r.statusClass}">${r.statusTxt}</span></td><td style="font-size:11px">${r.destinatario.substring(0,20)}</td><td style="font-size:12px">${r.problema}</td><td style="font-size:11px">${r.motorista}</td><td>${r.cidade}</td>`;
                tb.appendChild(tr);
            });
        }
        function renderTopLists() {
            const render = (id, k, cl) => {
                const c = {}; dadosFiltrados.forEach(d => c[d[k]||"N/D"] = (c[d[k]||"N/D"]||0)+1);
                const s = Object.entries(c).sort((a,b)=>b[1]-a[1]).slice(0,10);
                const el = document.getElementById(id); el.innerHTML = "";
                if(s.length===0) el.innerHTML="<div style='text-align:center;color:#999'>Sem dados</div>";
                else { const max = s[0][1]; s.forEach(([n,q]) => el.innerHTML+=`<div class="rank-row"><div class="rank-name" title="${n}">${n}</div><div class="rank-bar-container"><div class="rank-bar ${cl}" style="width:${(q/max)*100}%"></div></div><div class="rank-count">${q}</div></div>`); }
            };
            render('listaTopCidades', 'cidade', 'bar-blue');
            render('listaTopProblemas', 'problema', 'bar-red');
        }
        let sDir = 'desc';
        function ordenar(k) {
            sDir = sDir==='asc'?'desc':'asc';
            dadosFiltrados.sort((a,b) => {
                let vA = a[k], vB = b[k]; if(typeof vA==='string'){vA=vA.toLowerCase();vB=vB.toLowerCase();}
                return (vA < vB ? -1 : 1) * (sDir==='asc'?1:-1);
            });
            renderTabela();
        }
        let sDirE = 'desc';
        function ordenarEvo(k) {
            sDirE = sDirE==='asc'?'desc':'asc';
            dadosEvolucaoDetalhados.sort((a,b) => {
                let vA = a[k], vB = b[k]; if(typeof vA==='string'){vA=vA.toLowerCase();vB=vB.toLowerCase();}
                return (vA < vB ? -1 : 1) * (sDirE==='asc'?1:-1);
            });
            renderTabelaEvo();
        }
        function copiarCodigos() {
            if(dadosFiltrados.length===0) { alert("Vazio!"); return; }
            const t = document.createElement("textarea"); t.value = dadosFiltrados.map(d=>d.codigo).join("\n");
            document.body.appendChild(t); t.select(); document.execCommand('copy'); document.body.removeChild(t);
            alert("CÃ³digos copiados!");
        }
        function exportarExcel(type) {
            const dt = type==='ops' 
                ? dadosFiltrados.map(d => ({ "Pedido": d.codigo, "Dias": d.diasRetidos, "Status": d.statusTxt, "Motivo": d.problema, "Motorista": d.motorista, "Cidade": d.cidade, "Destinatario": d.destinatario }))
                : dadosEvolucaoDetalhados.map(d => ({ "Pedido": d.codigo, "SituaÃ§Ã£o": d.statusEvo, "Dias Retidos": d.diasRetidos, "Motorista (Ret)": d.motorista, "Cidade": d.cidade, "Problema": d.problema }));
            const ws = XLSX.utils.json_to_sheet(dt);
            const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Dados");
            XLSX.writeFile(wb, type==='ops'?"Relatorio_Operacional.xlsx":"Relatorio_Evolucao.xlsx");
        }
    </script>
</body>
</html>